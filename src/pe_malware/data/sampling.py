import logging

import jax
import jax.numpy as jnp

logger = logging.getLogger(__name__)


def subsample_imbalanced_data(tokenized_data_jax, labels_jax, benign_ratio: float = 0.1, seed: int = 42):
    """Subsample data to create an imbalanced dataset with a specified Benign:Malware ratio.

    Args:
        tokenized_data_jax: Tokenized data array (JAX).
        labels_jax: Labels array (JAX).
        benign_ratio: Ratio of benign samples (default: 0.1 for 1:9 ratio).
        seed: Random seed for reproducibility.

    Returns:
        Tuple of (subsampled_data, subsampled_labels).
    """
    benign_mask = labels_jax == 0
    malware_mask = labels_jax == 1

    benign_data = tokenized_data_jax[benign_mask]
    benign_labels = labels_jax[benign_mask]
    malware_data = tokenized_data_jax[malware_mask]
    malware_labels = labels_jax[malware_mask]

    num_malware = len(malware_labels)
    num_benign_target = int(num_malware * benign_ratio / (1 - benign_ratio))
    num_benign_target = min(num_benign_target, len(benign_labels))

    key = jax.random.PRNGKey(seed)
    benign_idx = jax.random.permutation(key, len(benign_labels))[:num_benign_target]
    benign_data_sub = benign_data[benign_idx]
    benign_labels_sub = benign_labels[benign_idx]

    combined_data = jnp.concatenate([benign_data_sub, malware_data], axis=0)
    combined_labels = jnp.concatenate([benign_labels_sub, malware_labels], axis=0)

    logger.info("Imbalanced dataset created:")
    logger.info(f"   Benign: {len(benign_labels_sub)} samples")
    logger.info(f"   Malware: {len(malware_labels)} samples")
    logger.info(f"   Ratio: 1:{len(malware_labels) / len(benign_labels_sub):.1f}")

    return combined_data, combined_labels
