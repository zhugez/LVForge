"""Plotting utilities for training metrics and evaluation curves."""

import logging

import plotly.graph_objects as go
from plotly.subplots import make_subplots

logger = logging.getLogger(__name__)


def plot_training_metrics(train_metrics, val_metrics, filepath, title="Training Metrics"):
    """Plot loss, accuracy, and F1 curves and save as HTML."""
    epochs = list(range(1, len(train_metrics['loss']) + 1))
    fig = make_subplots(rows=1, cols=3, subplot_titles=('Loss', 'Accuracy', 'F1 Score'))

    fig.add_trace(go.Scatter(x=epochs, y=train_metrics['loss'], name='Train Loss'), row=1, col=1)
    fig.add_trace(go.Scatter(x=epochs, y=val_metrics['loss'], name='Val Loss'), row=1, col=1)

    fig.add_trace(go.Scatter(x=epochs, y=train_metrics['accuracy'], name='Train Acc'), row=1, col=2)
    fig.add_trace(go.Scatter(x=epochs, y=val_metrics['accuracy'], name='Val Acc'), row=1, col=2)

    fig.add_trace(go.Scatter(x=epochs, y=train_metrics['f1'], name='Train F1'), row=1, col=3)
    fig.add_trace(go.Scatter(x=epochs, y=val_metrics['f1'], name='Val F1'), row=1, col=3)

    fig.update_layout(title_text=title, showlegend=True, width=1200, height=500)
    fig.write_html(filepath)
    logger.info(f"Training metrics saved to {filepath}")


def plot_roc_pr_curves(y_true, y_score, suffix=""):
    """Plot ROC and PR curves and save as HTML."""
    from sklearn.metrics import roc_curve, auc, precision_recall_curve

    fpr, tpr, _ = roc_curve(y_true, y_score)
    roc_auc = auc(fpr, tpr)

    fig_roc = go.Figure()
    fig_roc.add_trace(go.Scatter(x=fpr, y=tpr, mode='lines', name=f'ROC curve (AUC = {roc_auc:.8f})'))
    fig_roc.add_trace(go.Scatter(x=[0, 1], y=[0, 1], mode='lines',
                                  line=dict(dash='dash', color='black'), name='Random Classifier'))
    fig_roc.update_layout(title=f'ROC Curve{" (" + suffix + ")" if suffix else ""}',
                           xaxis_title='False Positive Rate', yaxis_title='True Positive Rate',
                           width=700, height=700)
    roc_path = f'roc_curve{"_" + suffix if suffix else ""}.html'
    fig_roc.write_html(roc_path)
    logger.info(f"ROC Curve saved to {roc_path}")

    precision, recall, _ = precision_recall_curve(y_true, y_score)
    pr_auc = auc(recall, precision)

    fig_pr = go.Figure()
    fig_pr.add_trace(go.Scatter(x=recall, y=precision, mode='lines', name=f'PR curve (AUC = {pr_auc:.8f})'))
    fig_pr.update_layout(title=f'Precision-Recall Curve{" (" + suffix + ")" if suffix else ""}',
                          xaxis_title='Recall', yaxis_title='Precision',
                          width=700, height=700)
    pr_path = f'pr_curve{"_" + suffix if suffix else ""}.html'
    fig_pr.write_html(pr_path)
    logger.info(f"PR Curve saved to {pr_path}")
